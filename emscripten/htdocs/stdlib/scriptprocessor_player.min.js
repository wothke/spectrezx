/**
* Generic ScriptProcessor based WebAudio player. 
*	version 1.02 (with WASM support)
*
* 	Copyright (C) 2017 Juergen Wothke
*
* Terms of Use: This software is licensed under a CC BY-NC-SA 
* (http://creativecommons.org/licenses/by-nc-sa/4.0/).
*/
var fetchSamples=function(e){window.player.genSamples.bind(window.player)(e)},calcTick=function(e){window.player.tick.bind(window.player)(e)},setGlobalWebAudioCtx=function(){if(void 0===window._gPlayerAudioCtx){var t="Web Audio API is not supported in this browser";try{"AudioContext"in window?window._gPlayerAudioCtx=new AudioContext:"webkitAudioContext"in window?window._gPlayerAudioCtx=new webkitAudioContext:alert(t+e)}catch(e){alert(t+e)}}};function surrogateCtor(){}function extend(e,t,i){for(var a in surrogateCtor.prototype=e.prototype,t.prototype=new surrogateCtor,t.prototype.constructor=t,t.base=e,i)t.prototype[a]=i[a];return t}AbstractTicker=function(){},AbstractTicker.prototype={init:function(e,t){},calcTickData:function(e,t){},computeAudioSamplesNotify:function(){}};var SAMPLES_PER_BUFFER=8192;AudioBackendAdapterBase=function(e,t){this._resampleBuffer=new Float32Array,this._channels=e,this._bytesPerSample=t,this._sampleRate=44100,this._inputSampleRate=44100,this._observer,this._manualSetupComplete=!0},AudioBackendAdapterBase.prototype={computeAudioSamples:function(){this.error("computeAudioSamples")},loadMusicData:function(e,t,i,a,r){this.error("loadMusicData")},evalTrackOptions:function(e){this.error("evalTrackOptions")},updateSongInfo:function(e,t){this.error("updateSongInfo")},getSongInfoMeta:function(){this.error("getSongInfoMeta")},getAudioBuffer:function(){this.error("getAudioBuffer")},getAudioBufferLength:function(){this.error("getAudioBufferLength")},readFloatSample:function(e,t){this.error("readFloatSample")},getBytesPerSample:function(){return this._bytesPerSample},getChannels:function(){return this._channels},isAdapterReady:function(){return!0},uploadFile:function(e,t){return 0},isManualSetupComplete:function(){return this._manualSetupComplete},teardown:function(){this.error("teardown")},getMaxPlaybackPosition:function(){return 0},getPlaybackPosition:function(){return 0},seekPlaybackPosition:function(e){return-1},getPathAndFilename:function(e){this.error("getPathAndFilename")},registerFileData:function(e,t){this.error("registerFileData")},mapBackendFilename:function(e){return e},handleBackendSongAttributes:function(e,t){this.error("handleBackendSongAttributes")},setObserver:function(e){this._observer=e},notifyAdapterReady:function(){void 0!==this._observer&&this._observer.notify()},error:function(e){alert("fatal error: abstract method '"+e+"' must be defined")},resetSampleRate:function(e,t){e>0&&(this._sampleRate=e),t>0&&(this._inputSampleRate=t);var i=Math.round(SAMPLES_PER_BUFFER*this._sampleRate/this._inputSampleRate)*this.getChannels();i>this._resampleBuffer.length&&(this._resampleBuffer=this.allocResampleBuffer(i))},allocResampleBuffer:function(e){return new Float32Array(e)},getCopiedAudio:function(e,t){var i;for(i=0;i<t*this._channels;i++)this._resampleBuffer[i]=this.readFloatSample(e,i);return t},getResampledAudio:function(e,t){var i;if(this._sampleRate==this._inputSampleRate)i=this.getCopiedAudio(e,t);else{var a=(i=Math.round(t*this._sampleRate/this._inputSampleRate))*this._channels;a>this._resampleBuffer.length&&(this._resampleBuffer=this.allocResampleBuffer(a)),this.resampleChannel(0,e,t,i),2==this._channels&&this.resampleChannel(1,e,t,i)}return i},resampleChannel:function(e,t,i,a){for(var r,n,s=0,o=0,d=a-0,h=i-0,u=Math.abs(d-s),l=s<d?1:-1,c=-Math.abs(h-o),f=o<h?1:-1,p=u+c;n=s*this._channels+e,this._resampleBuffer[n]=this.readFloatSample(t,o*this._channels+e),!(s>=d&&o>=h);)(r=2*p)>c&&(p+=c,s+=l),r<u&&(p+=u,o+=f)},getResampleBuffer:function(){return this._resampleBuffer}},EmsHEAP16BackendAdapter=function(){var e=function(t,i){e.base.call(this,i,2),this.Module=t,this.Module.adapterCallback=function(){this.doOnAdapterReady(),this.notifyAdapterReady()}.bind(this),window.Math.fround||(window.Math.fround=window.Math.round)};return extend(AudioBackendAdapterBase,e,{doOnAdapterReady:function(){},isAdapterReady:function(){return void 0===this.Module.notReady||!this.Module.notReady},registerEmscriptenFileData:function(e,t){try{this.Module.FS_createPath("/",e[0],!0,!0)}catch(e){}var i;try{i=this.Module.FS_createDataFile(e[0],e[1],t,!0,!0);ScriptNodePlayer.getInstance().trace("registerEmscriptenFileData: ["+e[0]+"]["+e[1]+"] size: "+t.length)}catch(e){}return i},readFloatSample:function(e,t){return this.Module.HEAP16[e+t]/32768},getCopiedAudio:function(e,t){var i=0;for(i=0;i<t*this._channels;i++)this._resampleBuffer[i]=this.Module.HEAP16[e+i]/32768;return t}}),e}(),FileCache=function(){this._binaryFileMap={},this._pendingFileMap={},this._isWaitingForFile=!1},FileCache.prototype={getFileMap:function(){return this._binaryFileMap},getPendingMap:function(){return this._pendingFileMap},setWaitingForFile:function(e){this._isWaitingForFile=e},isWaitingForFile:function(){return this._isWaitingForFile},getFile:function(e){var t;return e in this._binaryFileMap&&(t=this._binaryFileMap[e]),t},setFile:function(e,t){this._binaryFileMap[e]=t,this._isWaitingForFile=!1}};var ScriptNodePlayer=(PlayerImpl=function(e,t,i,a,r,n,s,o,d){void 0===e&&alert("fatal error: backendAdapter not specified"),void 0===r&&alert("fatal error: onPlayerReady not specified"),void 0===n&&alert("fatal error: onTrackReadyToPlay not specified"),void 0===s&&alert("fatal error: onTrackEnd not specified"),e.getChannels()>2&&alert("fatal error: only 1 or 2 output channels supported"),this._backendAdapter=e,this._backendAdapter.setObserver(this),this._basePath=t,this._traceSwitch=!1,this._spectrumEnabled=a,this._songInfo={},this._onTrackReadyToPlay=n,this._onTrackEnd=s,this._onPlayerReady=r,this._onUpdate=o,this._tickerStepWidth=256,void 0!==d&&d.init(SAMPLES_PER_BUFFER,this._tickerStepWidth),this._externalTicker=d,this._currentTick=0,this._sourceBuffer,this._sourceBufferLen,this._numberOfSamplesRendered=0,this._numberOfSamplesToRender=0,this._sourceBufferIdx=0,this._currentPlaytime=0,this._currentTimeout=-1,setGlobalWebAudioCtx(),this._sampleRate=window._gPlayerAudioCtx.sampleRate,this._correctSampleRate=this._sampleRate,this._backendAdapter.resetSampleRate(this._sampleRate,-1),this._bufferSource,this._gainNode,this._analyzerNode,this._scriptNode,this._freqByteData=0,window.fileRequestCallback=this.fileRequestCallback.bind(this),window.fileSizeRequestCallback=this.fileSizeRequestCallback.bind(this),window.songUpdateCallback=this.songUpdateCallback.bind(this),this._isPaused=!1,this._isPlayerReady=!1,this._isSongReady=!1,this._initInProgress=!1,this._preLoadReady=!1,window.player=this,window.player.preloadFiles.bind(window.player)(i,function(){this._preLoadReady=!0,this._preLoadReady&&this._backendAdapter.isAdapterReady()&&this._backendAdapter.isManualSetupComplete()&&(this._isPlayerReady=!0,this._onPlayerReady())}.bind(this))},PlayerImpl.prototype={notify:function(){if(void 0!==this.deferredPreload&&this._backendAdapter.isAdapterReady()){var e=this.deferredPreload[0],t=this.deferredPreload[1];delete this.deferredPreload,this.preload(e,e.length,t)}this._preLoadReady&&this._backendAdapter.isAdapterReady()&&this._backendAdapter.isManualSetupComplete()&&(this._isPlayerReady=!0,this._onPlayerReady())},handleBackendEvent:function(){this.notify()},isReady:function(){return this._isPlayerReady},setTraceMode:function(e){this._traceSwitch=e},play:function(){this.initWebAudio(),this._isPaused=!1,void 0===this._bufferSource&&(this._bufferSource=window._gPlayerAudioCtx.createBufferSource(),this._bufferSource.start||(this._bufferSource.start=this._bufferSource.noteOn,this._bufferSource.stop=this._bufferSource.noteOff),this._bufferSource.start(0))},pause:function(){this.isWaitingForFile()||this._initInProgress||!this._isSongReady||(this._isPaused=!0)},isPaused:function(){return this._isPaused},resume:function(){this.isWaitingForFile()||this._initInProgress||!this._isSongReady||(this._isPaused=!1)},getCurrentTick:function(){var e=Math.ceil(SAMPLES_PER_BUFFER/this._tickerStepWidth)-1;return e=Math.min(e,this._currentTick)},setVolume:function(e){void 0!==this._gainNode&&(this._gainNode.gain.value=e)},isStereo:function(){return 2==this._backendAdapter.getChannels()},getSongInfo:function(){return this._songInfo},getSongInfoMeta:function(){return this._backendAdapter.getSongInfoMeta()},setPlaybackTimeout:function(e){this._currentPlaytime=0,this._currentTimeout=e/1e3*this._sampleRate},getPlaybackTimeout:function(e){return this._currentTimeout<0?-1:Math.round(this._currentTimeout/this._sampleRate)},getCurrentPlaytime:function(){return Math.round(this._currentPlaytime/this._sampleRate)},getFreqByteData:function(){return this._analyzerNode&&(0===this._freqByteData&&(this._freqByteData=new Uint8Array(this._analyzerNode.frequencyBinCount)),this._analyzerNode.getByteFrequencyData(this._freqByteData)),this._freqByteData},getMaxPlaybackPosition:function(){return this._backendAdapter.getMaxPlaybackPosition()},getPlaybackPosition:function(){return this._backendAdapter.getPlaybackPosition()},seekPlaybackPosition:function(e){return this._backendAdapter.seekPlaybackPosition(e)},loadMusicFromTmpFile:function(e,t,i,a,r){var n=e.name,s=(t.basePath?t.basePath:this._basePath)+n;if(!this.loadMusicDataFromCache(s,t,a)){var o=new FileReader;o.onload=function(){var e=this._backendAdapter.getPathAndFilename(n),r=new Uint8Array(o.result);void 0!==this._backendAdapter.registerFileData(e,r)?(this.getCache().setFile(s,r),this.prepareTrackForPlayback(s,o.result,t),i(n)):a()}.bind(this),o.onprogress=function(e){r&&r(e.total,e.loaded)}.bind(this),o.readAsArrayBuffer(e)}},loadMusicFromURL:function(e,t,i,a,r){var n=(t.basePath?t.basePath:this._basePath)+e;if(!this.loadMusicDataFromCache(n,t,a)){var s=new XMLHttpRequest;s.open("GET",n,!0),s.responseType="arraybuffer",s.onload=function(e){this.trace("loadMusicFromURL successfully loaded: "+n),this.prepareTrackForPlayback(n,s.response,t)?i(n):this.isWaitingForFile()||a()}.bind(this),s.onprogress=function(e){r&&r(e.total,e.loaded)}.bind(this),s.onreadystatuschange=function(e){4==oReq.readyState&&404==oReq.status&&this.trace("loadMusicFromURL failed to load: "+n)}.bind(this),s.send(null)}},uploadFile:function(e,t,i,a,r){var n=new FileReader;n.onload=function(){var r=this._backendAdapter.getPathAndFilename(e.name),s=new Uint8Array(n.result);if(void 0!==this._backendAdapter.registerFileData(r,s)){var o=this._backendAdapter.uploadFile(e.name,t);0===o?(i(e.name),this._onPlayerReady()):1==o&&i(e.name)}else a()}.bind(this),n.onprogress=function(e){r&&r(e.total,e.loaded)}.bind(this),n.readAsArrayBuffer(e)},prepareTrackForPlayback:function(e,t,i){return this._isPaused=!0,this.lastUsedFilename=e,this.lastUsedData=t,this.lastUsedOptions=i,this._isSongReady=!1,this.setWaitingForFile(!1),this.initIfNeeded(e,t,i)},trace:function(e){this._traceSwitch&&console.log(e)},setWait:function(e){this.setWaitingForFile(e)},getDefaultSampleRate:function(){return this._correctSampleRate},initIfNeeded:function(e,t,i){var a=this.loadMusicData(e,t,i);if(a<0)this._isSongReady=!1,this.setWaitingForFile(!0),this._initInProgress=!1;else{if(0===a)return this.setWaitingForFile(!1),this._isSongReady=!0,this._currentPlaytime=0,this._initInProgress=!1,this.trace("successfully completed init"),0!==this._backendAdapter.evalTrackOptions(i)?(this.trace("error preparing track options"),!1):(this.updateSongInfo(e),this._onTrackReadyToPlay(),this._isPaused=!1,!0);this._initInProgress=!1,this.trace("initIfNeeded - fatal error")}return!1},loadMusicDataFromCache:function(e,t,i){var a=this.getCache().getFile(e);return void 0!==a&&(this.prepareTrackForPlayback(e,a,t)||this.isWaitingForFile()||i(),!0)},initWebAudio:function(){void 0!==this._bufferSource?this._bufferSource.stop(0):(this._analyzerNode=window._gPlayerAudioCtx.createAnalyser(),this._scriptNode=this.createScriptProcessor(window._gPlayerAudioCtx),this._gainNode=window._gPlayerAudioCtx.createGain(),this._scriptNode.connect(this._gainNode),void 0!==this._externalTicker&&this.createTickerScriptProcessor(window._gPlayerAudioCtx).connect(this._gainNode),this._spectrumEnabled?(this._gainNode.connect(this._analyzerNode),this._analyzerNode.connect(window._gPlayerAudioCtx.destination)):this._gainNode.connect(window._gPlayerAudioCtx.destination))},updateSongInfo:function(e){this._songInfo={},this._backendAdapter.updateSongInfo(e,this._songInfo)},loadMusicData:function(e,t,i){if(this._backendAdapter.teardown(),t){var a=this._backendAdapter.getPathAndFilename(e),r=new Uint8Array(t);this._backendAdapter.registerFileData(a,r);var n=this._backendAdapter.loadMusicData(this._sampleRate,a[0],a[1],r,i);return 0===n&&this.resetBuffer(),n}},resetBuffer:function(){this._numberOfSamplesRendered=0,this._numberOfSamplesToRender=0,this._sourceBufferIdx=0},resetSampleRate:function(e){this._backendAdapter.resetSampleRate(e,-1),this.resetBuffer()},createScriptProcessor:function(e){var t=e.createScriptProcessor(SAMPLES_PER_BUFFER,0,this._backendAdapter.getChannels());return t.onaudioprocess=fetchSamples,t},createTickerScriptProcessor:function(e){var t;return(t=e.createScriptProcessor(256,0,1)).onaudioprocess=calcTick,t},fillEmpty:function(e,t,a){var r=e-this._numberOfSamplesRendered;for(i=0;i<r;i++)t[i+this._numberOfSamplesRendered]=0,this.isStereo()&&(a[i+this._numberOfSamplesRendered]=0);this._numberOfSamplesToRender=0,this._numberOfSamplesRendered=e},fileRequestCallback:function(e){var t=this._backendAdapter.mapBackendFilename(e);return this.preloadFile(t,function(){this.initIfNeeded(this.lastUsedFilename,this.lastUsedData,this.lastUsedOptions)}.bind(this),!1)},fileSizeRequestCallback:function(e){var t=this._backendAdapter.mapBackendFilename(e);return this.getCache().getFile(t).length},songUpdateCallback:function(e){this._backendAdapter.handleBackendSongAttributes(e,this._songInfo),this._onUpdate&&this._onUpdate()},preload:function(e,t,i){if(0===t)i();else{t--;var a=function(){this.preload(e,t,i)}.bind(this);this.preloadFile(e[t],a,!0)}},preloadFile:function(e,t,i){var a=this.getCache().getFile(e);if(void 0!==a){var r=0;return 0==a&&(r=1,this.trace("error: preloadFile could not get cached: "+e)),i&&t(),r}if(this._isPaused=!0,this.setWaitingForFile(!0),this._isSongReady=!1,!(e in this.getCache().getPendingMap())){this.getCache().getPendingMap()[e]=1;var n=new XMLHttpRequest;n.open("GET",e,!0),n.responseType="arraybuffer",n.onload=function(i){var a=n.response;if(a){this.trace("preloadFile successfully loaded: "+e);var r=this._backendAdapter.getPathAndFilename(e),s=new Uint8Array(a);this._backendAdapter.registerFileData(r,s),this.getCache().setFile(e,s)}delete this.getCache().getPendingMap()[e]||this.trace("remove file from pending failed: "+e),t()}.bind(this),n.onreadystatuschange=function(t){4==n.readyState&&404==n.status&&(this.trace("preloadFile failed to load: "+e),this.getCache().setFile(e,0))}.bind(this),n.onerror=function(t){this.getCache().setFile(e,0)}.bind(this),n.send(null)}return-1},tick:function(e){this._currentTick++},genSamples:function(e){var t,i=e.outputBuffer.getChannelData(0);if(this.isStereo()&&(t=e.outputBuffer.getChannelData(1)),!this._isSongReady||this.isWaitingForFile()||this._isPaused){var a;for(a=0;a<i.length;a++)i[a]=0,this.isStereo()&&(t[a]=0)}else{var r=i.length;for(this._numberOfSamplesRendered=0;this._numberOfSamplesRendered<r;){if(0===this._numberOfSamplesToRender){var n;if(this._currentTimeout>0&&this._currentPlaytime>this._currentTimeout?(this.trace("'song end' forced after "+this._currentTimeout/this._sampleRate+" secs"),n=1):(n=this._backendAdapter.computeAudioSamples(),void 0!==this._externalTicker&&this._externalTicker.computeAudioSamplesNotify()),0!==n)return this.fillEmpty(r,i,t),n<0?(this._isPaused=!0,this._isSongReady=!1,void this.setWaitingForFile(!0)):this.isWaitingForFile()?void 0:(n>1&&this.trace("playback aborted with an error"),void(this._onTrackEnd?this._onTrackEnd():this._isPaused=!0));this._sourceBuffer=this._backendAdapter.getAudioBuffer(),this._sourceBufferLen=this._backendAdapter.getAudioBufferLength(),this._numberOfSamplesToRender=this._backendAdapter.getResampledAudio(this._sourceBuffer,this._sourceBufferLen),this._sourceBufferIdx=0}var s=this._backendAdapter.getResampleBuffer();this.isStereo()?this.copySamplesStereo(s,i,t,r):this.copySamplesMono(s,i,t,r)}this._currentPlaytime+=r}void 0!==this._externalTicker&&(this._externalTicker.calcTickData(i,t),this._currentTick=0)},copySamplesStereo:function(e,t,i,a){var r;if(this._numberOfSamplesRendered+this._numberOfSamplesToRender>a){var n=a-this._numberOfSamplesRendered;for(r=0;r<n;r++)t[r+this._numberOfSamplesRendered]=e[this._sourceBufferIdx++],i[r+this._numberOfSamplesRendered]=e[this._sourceBufferIdx++];this._numberOfSamplesToRender-=n,this._numberOfSamplesRendered=a}else{for(r=0;r<this._numberOfSamplesToRender;r++)t[r+this._numberOfSamplesRendered]=e[this._sourceBufferIdx++],i[r+this._numberOfSamplesRendered]=e[this._sourceBufferIdx++];this._numberOfSamplesRendered+=this._numberOfSamplesToRender,this._numberOfSamplesToRender=0}},copySamplesMono:function(e,t,i,a){var r;if(this._numberOfSamplesRendered+this._numberOfSamplesToRender>a){var n=a-this._numberOfSamplesRendered;for(r=0;r<n;r++)t[r+this._numberOfSamplesRendered]=e[this._sourceBufferIdx++];this._numberOfSamplesToRender-=n,this._numberOfSamplesRendered=a}else{for(r=0;r<this._numberOfSamplesToRender;r++)t[r+this._numberOfSamplesRendered]=e[this._sourceBufferIdx++];this._numberOfSamplesRendered+=this._numberOfSamplesToRender,this._numberOfSamplesToRender=0}},preloadFiles:function(e,t){this._isPaused=!0,this._backendAdapter.isAdapterReady()?this.preload(e,e.length,t):this.deferredPreload=[e,t]},setWaitingForFile:function(e){this.getCache().setWaitingForFile(e)},isWaitingForFile:function(){return this.getCache().isWaitingForFile()},getCache:function(){return void 0===window._fileCache&&(window._fileCache=new FileCache),window._fileCache}},{createInstance:function(e,t,i,a,r,n,s,o,d){var h=!1;if(void 0!==window.player){var u=window.player;u._isPaused=!0,void 0!==u._bufferSource&&u._bufferSource.stop(0),u._scriptNode&&u._scriptNode.disconnect(0),u._analyzerNode&&u._analyzerNode.disconnect(0),u._gainNode&&u._gainNode.disconnect(0),h=u._traceSwitch}new PlayerImpl(e,t,i,a,r,n,s,o,d)._traceSwitch=h},getInstance:function(){return void 0===window.player&&alert("fatal error: window.player not defined"),window.player}});